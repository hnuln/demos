<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta charset="UTF-8">
	<title>通读在线阅读</title>
	<link href="../jquery.touchPDF.css" rel="stylesheet" media="screen" />
	<link href="./index.css" rel="stylesheet" media="screen" />
</head>

<body>
	<div class="contrainer">
		<div id="myPDF" class="myPDF-box-css"></div>
		<div class="father-box" id="father-box">
			<div id='drag-drop-box' class="drag-drop-box-css">
				<div class="box" id="my-signImg">
					<span class="br" id="signImg-br" style="touch-action: none"></span>
					<img src="" id="signUrl" class="my-img">
				</div>
			</div>
		</div>
		<div class="my-btn-box">
			<div class="my-btn-content">
				<!-- <div class="my-btn-item my-sure">保存</div>
				<div class="my-btn-item my-cancal">取消</div> -->
			</div>
		</div>
	</div>

	<script type="text/javascript" src="../pdf.compatibility.js"></script>
	<script type="text/javascript" src="../pdf.js"></script>
	<script type="text/javascript" src="../jquery.min.js"></script>
	<script type="text/javascript" src="../jquery.touchSwipe.js"></script>
	<script type="text/javascript" src="../jquery.touchPDF.js"></script>
	<script type="text/javascript" src="../jquery.panzoom.js"></script>
	<script type="text/javascript" src="../jquery.mousewheel.js"></script>
	<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
	<script type="text/javascript" src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"></script>
	</script>
	<script type="text/javascript">
		// h5与小程序通信环境监听
		document.addEventListener('UniAppJSBridgeReady', function () {
			uni.webView.getEnv(function (res) {
				console.log('当前环境：' + JSON.stringify(res));
			});
		});

		// 获取传入的URL
		function getUrlParam(name) {
			var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); // 构造一个含有目标参数的正则表达式对象
			var r = window.location.search.substr(1).match(reg); // 匹配目标参数
			if (r != null) return r[2];
			return null; // 返回参数值
		};

		// 初始化pdf等
		$(function () {
			let url = decodeURIComponent(getUrlParam('url'));
			let signImgUrl = decodeURIComponent(getUrlParam('signImgUrl'))
			document.getElementById('signUrl').src = './sign.jpeg' || signImgUrl;

			let name = getUrlParam('docName');
			document.title = decodeURIComponent(name || 'document');
			// let myHeight = 550;
			// document.getElementById('myPDF').style.height = myHeight + 'px';
			$("#myPDF").pdf({
				source: './my.pdf',
				title: '',
			});
			let oPdfbox = document.getElementById('my-pdf-outerdiv');
			let pdfinitHeight = oPdfbox.clientHeight;
			let pdfinitScale = oPdfbox.style.transform.split('(')[1].split(')')[0].split(',');
			let h = pdfinitHeight * pdfinitScale;

			// document.getElementById('father-box').style.height = h + 'px';
		});
		window.onload = function () {
			// window.location.href 获取地址
			let url = window.location.href
			let p = url.split('?')[1]
			let params = new URLSearchParams(p)
			// console.log(params.get('path')) //1
			if (params.get('request')) {
				// 签字状态
				// 1.底部保存取消按钮
				// 2.文档部分渲染签字图片
				document.querySelector('.father-box').style.display = 'block'
				document.querySelector('.father-box').style.height = 0
				const btnSubmit = document.createElement('div')
				const btnCancel = document.createElement('div')
				btnSubmit.innerHTML = '保存'
				btnCancel.innerHTML = '取消'
				btnCancel.classList.add('my-btn-item', 'my-cancal')
				btnSubmit.classList.add('my-btn-item', 'my-sure')
				document.querySelector('.my-btn-content').appendChild(btnSubmit)
				document.querySelector('.my-btn-content').appendChild(btnCancel)
				// 取消
				document.querySelector('.my-cancal').addEventListener('click', () => {
					console.log("取消");
					uni.webView.navigateBack()
				})
				// 确定
				document.querySelector('.my-sure').addEventListener('click', () => {
					console.log("确认");
					let oSignImg = document.getElementById('my-signImg');
					var oTimeImg = document.getElementById('my-timeImg');
					var page = localStorage.getItem("myPageNum");
					page = parseInt(page);
					var oPDFBOX = document.getElementById('myPDF');
					let oPdfbox = document.getElementById('my-pdf-outerdiv');
					let pdfinitHeight = oPdfbox.clientHeight;
					let pdfinitScale = oPdfbox.style.transform.split('(')[1].split(')')[0].split(',');
					let pdf_height = pdfinitHeight * pdfinitScale;
					let pdf_width = oPdfbox.clientWidth * pdfinitScale
					uni.postMessage({
						data: {
							signDatas: {
								page_no: page,
								image_id: '',
								pdf_height: pdf_height,
								pdf_width: pdf_width,
								width: oSignImg.offsetWidth,
								height: oSignImg.offsetHeight,
								top: oSignImg.offsetTop,
								left: oSignImg.offsetLeft,
							}
						}
					});
					uni.webView.navigateBack()
				})
				var oSignImg = document.getElementById('my-signImg');
				var oFatherBox = document.getElementById('drag-drop-box');
				var oSignBr = document.getElementById('signImg-br');
				oSignImg.style.width = '120px';
				initListener('father', oSignImg);
				initListener('bottomRight', oSignBr, oSignImg);

				function initListener(type, eDom, faterDom) {
					eDom.addEventListener('touchstart', function (e) {
						var ev = e || window.event;
						var touch = ev.targetTouches[0];
						ev.stopPropagation();
						console.log(touch.clientX, eDom.offsetLeft);
						console.log(touch.clientY, eDom.offsetTop);
						oL = touch.clientX - eDom.offsetLeft; // 触摸点距离box盒子左边框距离
						oT = touch.clientY - eDom.offsetTop; // 触摸点距离box盒子上边框距离
						document.addEventListener("touchmove", defaultEvent);
					})
					eDom.addEventListener('touchmove', function (e) {
						var ev = e || window.event;
						ev.stopPropagation();
						var touch = ev.targetTouches[0];
						if (type === 'father') {
							eDom.style.left = touch.clientX - oL + 'px';
							eDom.style.top = touch.clientY - oT + 'px';
							// InitBoundary(eDom);
						} else if (type === 'bottomRight') {
							faterDom.style.width = touch.clientX - oL + 'px';
							faterDom.style.height = touch.clientY - oT + 'px';
							// InitBoundary(faterDom);
						}
					})
					eDom.addEventListener('touchend', function () {
						document.removeEventListener("touchmove", defaultEvent);
					})
					function InitBoundary(eDom) {
						let oDivWidth = eDom.offsetWidth;
						let oDivHeight = eDom.offsetHeight;
						let oDivLeft = eDom.offsetLeft;
						let oDivTop = eDom.offsetTop;
						let bodyWidth = oFatherBox.offsetWidth;
						let bodyHeight = oFatherBox.offsetHeight;
						// 左边界 
						if (oDivLeft <= 0) {
							eDom.style.left = 0 + 'px'
						}
						// 右边界 多减5个像素减去的是防止滚动条会造成抖动
						if ((oDivLeft + oDivWidth) >= (bodyWidth - 24)) {
							eDom.style.left = bodyWidth - oDivWidth - 24 + 'px'
						}
						//上边界
						if (oDivTop <= 0) {
							eDom.style.top = 0 + 'px'
						}
						// 下边界 多减5个像素减去的是防止滚动条会造成抖动
						if (oDivTop + oDivHeight >= bodyHeight - 24) {
							eDom.style.top = bodyHeight - oDivHeight - 24 + 'px'
						}
					}
				}


				function defaultEvent(e) {
					e.preventDefault();
					e.stopPropagation();
				}
			} else {
				// 预览文件状态
				// 1.底部签署按钮
				const btnSign = document.createElement('div')
				btnSign.innerHTML = '签署'
				btnSign.classList.add('my-btn-item', 'sign')
				document.querySelector('.my-btn-content').appendChild(btnSign)
				btnSign.addEventListener('click', () => {
					// uni.webView.navigateBack()
					uni.webView.navigateTo({
						url: '/pages/signatureBoard/signatureBoard',
					})
				})
			}

		};
	</script>

</body>

</html>